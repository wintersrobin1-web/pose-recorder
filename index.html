<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pose – stabile Referenz</title>

<style>
body { font-family: system-ui; margin: 16px; }
.row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
video, canvas { width: 360px; border-radius: 12px; border: 1px solid #ccc; }
button { padding: 10px 14px; border-radius: 10px; }
pre { background:#f5f5f5; padding:8px; border-radius:8px; }
</style>
</head>

<body>

<h3>Pose – stabile Referenz</h3>

<div class="row">
  <button id="btnInit">Start</button>
  <button id="btnSwitch" disabled>Kamera wechseln</button>
</div>

<div class="row">
  <video id="video" autoplay muted playsinline></video>
  <canvas id="canvas"></canvas>
</div>

<pre id="debug">bereit</pre>

<script type="module">
import {
  FilesetResolver,
  PoseLandmarker,
  DrawingUtils
} from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14";

// ---------- DOM ----------
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const debug = document.getElementById("debug");

const btnInit = document.getElementById("btnInit");
const btnSwitch = document.getElementById("btnSwitch");

// ---------- State ----------
let landmarker = null;
let drawingUtils = null;
let stream = null;
let running = false;
let isBack = true;

// ---------- POSE CONNECTIONS (SICHER!) ----------
const POSE_CONNECTIONS = [
  [11,13],[13,15],
  [12,14],[14,16],
  [11,12],
  [23,24],
  [11,23],[12,24],
  [23,25],[25,27],
  [24,26],[26,28]
];

// ---------- Helpers ----------
function syncCanvas() {
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
}

function log(msg) {
  debug.textContent = msg;
}

// ---------- MediaPipe ----------
async function createLandmarker() {
  const fs = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm"
  );

  landmarker = await PoseLandmarker.createFromOptions(fs, {
    baseOptions: {
      modelAssetPath:
        "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_heavy/float16/1/pose_landmarker_heavy.task"
    },
    runningMode: "VIDEO",
    numPoses: 1
  });

  drawingUtils = new DrawingUtils(ctx);
}

// ---------- Camera ----------
async function startCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());

  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: isBack ? "environment" : "user" },
    audio: false
  });

  video.srcObject = stream;
  await video.play();

  await new Promise(r => {
    const check = () =>
      video.videoWidth ? r() : requestAnimationFrame(check);
    check();
  });

  syncCanvas();
}

// ---------- Loop ----------
function loop() {
  if (!running) return;

  ctx.fillStyle = "#bfe7ff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const res = landmarker.detectForVideo(video, performance.now());

  if (res.landmarks?.length) {
    const lm = res.landmarks[0];

    drawingUtils.drawConnectors(lm, POSE_CONNECTIONS, {
      color: "#000",
      lineWidth: 4
    });
    drawingUtils.drawLandmarks(lm, {
      color: "#000",
      radius: 3
    });

    log(`Landmarks: ${lm.length}`);
  } else {
    log("keine Pose erkannt");
  }

  requestAnimationFrame(loop);
}

// ---------- UI ----------
btnInit.onclick = async () => {
  btnInit.disabled = true;
  log("initialisiere…");

  await createLandmarker();
  await startCamera();

  running = true;
  btnSwitch.disabled = false;
  loop();
};

btnSwitch.onclick = async () => {
  running = false;
  isBack = !isBack;

  await startCamera();

  running = true;
  loop();
};
</script>
</body>
</html>
