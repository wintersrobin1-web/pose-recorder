<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Brust – Gleitphase (stabil)</title>

<style>
body { font-family: system-ui; margin:16px; }
.row { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0; }
video,canvas { width:360px; border-radius:12px; border:1px solid #ccc; }
button { padding:10px 14px; border-radius:10px; }
label { display:inline-flex; gap:6px; align-items:center; }
</style>
</head>

<body>

<h2>Brust – Gleitphase</h2>

<div class="row">
  <button id="btnInit">Kamera starten</button>
  <button id="btnSwitch" disabled>Kamera wechseln</button>
</div>

<div class="row">
  <label><input type="checkbox" id="showSkeleton" checked>Skelett</label>
  <label><input type="checkbox" id="showMask" checked>Silhouette</label>
</div>

<div class="row">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas"></canvas>
</div>

<p id="status">bereit</p>

<script type="module">
import { FilesetResolver, PoseLandmarker, DrawingUtils }
from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14";

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

const btnInit = document.getElementById("btnInit");
const btnSwitch = document.getElementById("btnSwitch");
const showSkeleton = document.getElementById("showSkeleton");
const showMask = document.getElementById("showMask");
const statusEl = document.getElementById("status");

let landmarker = null;
let drawingUtils = null;
let stream = null;
let running = false;
let isBack = true;
let rafId = null;

// ---------- Canvas ----------
function resizeCanvas() {
  const dpr = devicePixelRatio || 1;
  const w = 360, h = 640;
  canvas.style.width = w + "px";
  canvas.style.height = h + "px";
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
resizeCanvas();

// ---------- MediaPipe ----------
async function createLandmarker() {
  const fileset = await FilesetResolver.forVisionTasks(
    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm"
  );

  landmarker = await PoseLandmarker.createFromOptions(fileset, {
    baseOptions: {
      modelAssetPath:
        "https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_heavy/float16/1/pose_landmarker_heavy.task"
    },
    runningMode: "VIDEO",
    numPoses: 1,
    outputSegmentationMasks: true,
  });

  drawingUtils = new DrawingUtils(ctx);
}

// ---------- Kamera ----------
async function startCamera() {
  stopCamera();
  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: isBack ? "environment" : "user" },
    audio: false
  });
  video.srcObject = stream;
  await video.play();

  await new Promise(r => {
    const check = () =>
      video.videoWidth ? r() : requestAnimationFrame(check);
    check();
  });
}

function stopCamera() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
  video.srcObject = null;
}

// ---------- Loop ----------
function drawMask(mask) {
  if (!mask || !showMask.checked) return;

  ctx.save();
  ctx.globalAlpha = 0.85;
  ctx.drawImage(mask.getAsCanvas(), 0, 0, 360, 640);
  ctx.restore();
}

function loop() {
  if (!running || !landmarker) return;

  if (!video.videoWidth) {
    rafId = requestAnimationFrame(loop);
    return;
  }

  ctx.fillStyle = "#bfe7ff";
  ctx.fillRect(0,0,360,640);

  const ts = performance.now();
  const res = landmarker.detectForVideo(video, ts);

  if (res.segmentationMasks?.length) {
    drawMask(res.segmentationMasks[0]);
  }

  if (res.landmarks?.length && showSkeleton.checked) {
    drawingUtils.drawConnectors(
      res.landmarks[0],
      PoseLandmarker.POSE_CONNECTIONS,
      { color:"#000", lineWidth:4 }
    );
    drawingUtils.drawLandmarks(
      res.landmarks[0],
      { color:"#000", radius:3 }
    );
  }

  rafId = requestAnimationFrame(loop);
}

// ---------- UI ----------
btnInit.onclick = async () => {
  btnInit.disabled = true;
  statusEl.textContent = "Initialisiere…";
  resizeCanvas();
  await createLandmarker();
  await startCamera();
  running = true;
  btnSwitch.disabled = false;
  loop();
  statusEl.textContent = "bereit";
};

btnSwitch.onclick = async () => {
  btnSwitch.disabled = true;
  running = false;
  cancelAnimationFrame(rafId);

  isBack = !isBack;

  await startCamera();

  await landmarker.close();
  await createLandmarker();

  running = true;
  loop();

  btnSwitch.disabled = false;
};
</script>
</body>
</html>
